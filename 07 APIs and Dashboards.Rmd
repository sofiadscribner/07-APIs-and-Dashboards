---
title: "APIs and Dashboards"
subtitle: "MKTG 411 Marketing Analytics"
output: 
  ioslides_presentation:
    widescreen: true
    css: style.css
---

## Marketing Analytics Process

<center>
![](Figures/process_import.png){width=900px}
</center>

## Motivating Example

Now that your supervisor has seen you successfully work with the database and Qualtrics API, she wants you to find some way to display all of these visualizations in a more interactive format. She would like to avoid having to create a long report filled with scatterplots of every single combination of numerical variables, for example. How might this be accomplished?

## Marketing Analytics Process

<center>
![](Figures/process_communicate.png){width=900px}
</center>

---

![](Figures/hex_rmarkdown-flexdashboard-shiny.png){width=920px}

## Data Products

Remember that an analyst needs to interpret and communicate insights in a way that **clearly informs the managerial decision**. The form that communication takes depends on the audience.

- Professional visualizations are essential.
- Reports and presentations provide context, details, and explanations.
- Dashboards and webapps enable interacting with the data.
- APIs allow direct access to data, models, and results.

Dashboards, webapps, and APIs are examples of **data products**, ways to share data, models, and results interactively.

## Dashboards

We can use **dashboards** to interactively report on key performance indicators, visualizations, and data exploration. We can build dashboards using R Markdown. We'll also use [{shiny}](https://shiny.rstudio.com) functions, the industry-standard for webapps, to make the dashboard interactive.

Install the {markdown}, {rmarkdown}, {flexdashboard}, {shiny}, and {rsconnect} packages. Create a new dashboard by creating an **R Markdown** document > **From Template** > **Flex Dashboard**.

## Patagonia CRM Dashboard

We'll be building [this CRM dashboard](https://marcdotson.shinyapps.io/patagonia_crm/).

<center>
![](Figures/flexdashboard_example.png){width=850px}
</center>

## YAML

```
---
title: "Patagonia CRM Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
runtime: shiny
---
```

We have a new `output` (R Markdown's `format`) with its own arguments:

- `orientation` is the dashboard layout, either `columns` or `rows`.
- `vertical_layout` is how the dashboard fits, either `fill` or `scroll`.

To use shiny functions, we also need to add `runtime: shiny` to the YAML. **Pay attention to the white space in the YAML!**

## Setup

The first code cell is named `setup` and has `#| include: false` (the opposite of `#| eval: false`). Load packages and import data with *minimal* wrangling (it really should be already-wrangled data).

Note that the data **must be in the same folder as the dashboard .Rmd** which is also the *working directory* for the dashboard.

```{r eval=FALSE}

# Load packages.

library(tidyverse)
library(flexdashboard)
library(shiny)
library(rsconnect)

# Import data.

customer_data <- read_csv("customer_data.csv") |> 
  mutate(age = 2023 - birth_year)
```

## Layout | Add Rows and Columns

Depending on the `orientation` argument, additional elements will be in rows or columns. You can manage your dashboard layout by adding additional rows and columns.

```
Row
------------------------------------------
```

or 

```
Column
------------------------------------------
```

Code cells following the row or column header will show up in that row or column.

---

<center>
![](Figures/flexdashboard_row-orientation.png){width=900px}
</center>

---

<center>
![](Figures/flexdashboard_column-orientation.png){width=900px}
</center>

## Layout | Add a Sidebar

The interactive elements of a dashboard are conveniently included in a sidebar. Let's add one.

```
Sidebar {.sidebar}
------------------------------------------
```

Code cells following the sidebar header will show up in the sidebar.

## Input Functions

**Input functions** make the dashboard interactive. They allow the use to select or input variables which in turn adjust the visualizations. There are many different input functions, but they all include an input ID and an input label.

Let's add one to the sidebar.

```{r eval=FALSE}

selectInput(
  inputId = "region",
  label = "Region",
  choices = unique(customer_data$region)
)
```

Note that `customer_data$region` is a way to `select(customer_data, region)` without {dplyr}. Furthermore, we can't run this code cell on it's own -- we need to render the entire document to see the dashboard.

## Render Functions

Visualizations are at the heart of any interactive dashboard. In order to reference a *reactive* element like the input function we need to create the plot in a *reactive* environment using **render functions**.

Let's add a row, name the dashboard element within the row with a sub-heading `### Age and Credit`, and use a render function to add a plot.

```{r eval=FALSE}

renderPlot({
  customer_data |> 
    filter(region == input$region) |> 
    ggplot(aes(x = age, y = credit, color = gender)) +
    geom_jitter(size = 3, alpha = 0.5)
})
```

Note that to call an input you use `input$inputid`.

---

Let's add another row, name the dashboard element within the new row with a sub-heading `### Average Income`, and use another render function to produce a numeric summary in a call-out box with [favicon](https://fontawesome.com/v4.7.0/icons/).

```{r eval=FALSE}
# Add a value box (numeric summary).
renderValueBox({
  # Compute the average income.
  avg_income <- customer_data |> 
    filter(region == input$region) |> 
    summarize(avg_income = mean(income)) |> 
    pull()
  
  # Print the average income in a value box.
  valueBox(round(avg_income), icon = "fa-money")
})
```

---

Within the same row, let's add a second call-out box named `### Average Credit Score`.

```{r eval=FALSE}
# Add a value box (numeric summary).
renderValueBox({
  # Compute the average credit.
  avg_credit <- customer_data |> 
    filter(region == input$region) |> 
    summarize(avg_credit = mean(credit)) |> 
    pull()
  
  # Print the average credit in a value box.
  valueBox(round(avg_credit), icon = "fa-bank")
})
```

---

Finally, let's add a third call-out box named `### Median Age`.

```{r eval=FALSE}
# Add a value box (numeric summary).
renderValueBox({
  # Compute the median age.
  med_age <- customer_data |> 
    filter(region == input$region) |> 
    summarize(med_age = median(age)) |> 
    pull()
  
  # Print the median age in a value box.
  valueBox(med_age, icon = "fa-address-book")
})
```

## Publish a Dashboard

A dashboard is a kind of webapp and needs to be hosted on a server to share. Sign up for a free [shinyapps.io account](https://www.shinyapps.io/admin/#/signup), choose a username, and authorize API access with an API token and secret, which you'll need to *show and copy*.

<center>
![](Figures/flexdashboard_shinyapps-api.png){width=900px}
</center>

---

You can find your API token and secret again under *Tokens*.

<center>
![](Figures/flexdashboard_shinyapps-tokens.png){width=900px}
</center>

---

You can then publish your rendered dashboard.

<center>
![](Figures/flexdashboards_publish-01.png){width=900px}
</center>

---

Treat the title like a variable name and publish (which may take a few minutes)!

<center>
![](Figures/flexdashboards_publish-02.png){width=900px}
</center>

## Live Coding Exercise

What if we would like to add a regression line to our plot? How can we do that?

## Wrapping Up

*Summary*

- Discussed communicating marketing insights with your audience in mind.
- Walked through creating a dashboard with R Markdown and {shiny}.

*Next Time*

- Our first project week!

*Supplementary Material*

- [More on {flexdashboard}](https://pkgs.rstudio.com/flexdashboard/index.html)
- [*Mastering Shiny*](https://mastering-shiny.org)

## Exercise 7

In RStudio, do the following in *two* documents.

1. In a Quarto document with `format: docx`, wrangle the customer data to include the total amount spent in-store for each customer. Write this data as a CSV file *in the Exercises folder*.
2. In an R Markdown document, modify the dashboard from class by importing the new data, adding a second input function to the sidebar to select from `college_degree`, modifying the plot to filter on both input functions, replacing age with total amount spent in-store in the plot, and modifying the call-out boxes to filter on both input functions.
3. Knit the R Markdown document and publish it on shinyapps.io. Include the link at the end of the Quarto document (add a link with `[text](URL)`), rendered as a Word document, and upload to Canvas.
